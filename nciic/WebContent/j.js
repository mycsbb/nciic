/////////////////////////////////////////////////////////////////////////////////// // 文件名 ： xQuery.js // // 功 能 ： // 创建一个要素查询控件 /////////////////////////////////////////////////////////////////////////////////// // 查询类型 var QUERY_BY_PERSON = 0; // 人 var QUERY_BY_ADDRESS = 1; // 地 var QUERY_BY_UNIT = 2; // 户 var QUERY_BY_ORG = 3; // 组织 var QUERY_BY_STATION = 4; // 派出所 var QUERY_BY_PHOTO = 8; // 照片采集 var QUERY_BY_AJXX = 5; // 案件信息 var QUERY_BY_MJXX = 6; // 民警信息 var QUERY_BY_COMMON = 9; // 通用信息add by songxb@2007-05-15 var QUERY_BY_GAB = 7 // 公安部信息 var QUERY_BY_FZXX = 10 //房主信息 //-----------zl modi 080715----------------------------------------------------- var QUERY_BY_CUSTINFO =11; //查询客户信息 var QUERY_BY_UNITINFO =12; //查询用户信息 var QUERY_BY_MANAGER =13; //查询客户经理 //------------------------------------------------------------------------------ //-----------------------Zhy Add 081208 Start----------------------------------- var QUERY_BY_STAFF = 17; //查询员工信息 //-----------------------Zhy Add 081208 End------------------------------------- var QUERY_FILE_PATH = g_sQueryPath; // 查询文件的位置 var winColor="#7BA2E7"; var winTitleColor="navy"; var winCaretColor = "#FFCC33"; /////////////////////////////////////////////////////////////////////////////////// // 创建要素查询控件 // id : String 控件的 id // left : Integer 控件窗体的 Left // top : Integer 控件窗体的 Top // width : Integer 控件窗体的宽度 // height : Integer 控件窗体的高度 // function neu_xQuery(id, left, top, width, height) { this.id = id ? id : "neusoftQueryWin"; this.width = (width && width>200) ? parseInt(width) : 400; this.height = (height && height>250) ? parseInt(height) : 200; this.left = left ? parseInt(left) : (document.body.clientWidth - this.width) / 2; this.top = top ? parseInt(top) : (document.body.clientHeight - this.height) / 2; return document.getElementById(this._winTag + this.id) ? this : this.init(); } neu_xQuery.prototype = { //+------------------------------------ // Public 属性和方法 //------------------------------------- object: null, // 查询窗体 client: null, // 客户区 edit: null, // 进行查询的录入框 // 显示窗口 show: function (obj) { if (obj.src) { this.edit = obj; //modified by songxb@2007-05-15 增加了控件属性 url:页面路径 sWidth:查询页面宽度 sHeight:查询页面高度 this.doQuery(obj, obj.src, obj.param,obj.url,obj.sWidth,obj.sHeight); } }, // 隐藏窗口 hidden: function () { try { this.iframe.src = "about:blank"; this.object.close(); if (this.edit) { //this.edit.focus(); } } catch (e) {} }, //+------------------------------------ // Private 属性和方法 //------------------------------------- _winTag: "neu_xQuery", iframe: null, // 内嵌页面 init: function () { this.object = new neu_xWin( this.id, // 窗体的 id this.left, // 窗体的 Left this.top, // 窗体的 Top this.width, // 窗体的宽度 this.height, // 窗体的高度 //"查询窗口", // 窗体的标题 "\u67e5\u8be2\u7a97\u53e3", "", // 窗体客户区的内容 winTitleColor, // 窗体标题的颜色 winColor, // 窗体的颜色 winCaretColor, // 窗体拖拽时的颜色 "silver", // 窗体阴影的颜色 true, // 是否限制窗体移动范围 false, // 是否固定窗体位置 false // 是否永久保持固定窗体位置 ); var client = document.createElement("DIV"); this.client = client; with (client.style) { width = "100%"; height = "100%"; } var iframe = document.createElement(""); this.iframe = iframe; with (iframe) { width = "100%"; height = "100%"; scrolling = "no"; frameBorder = 0; src = "about:blank"; } client.appendChild(iframe); this.object.setClientByObject(client); this.hidden(); return this; }, // 设置客户区 setClient: function (sWeb, width, height) { if (this.object.isMinimize) { this.object.size(); } this.iframe.src = sWeb; this.object.setSize(width, height); this.width = width; this.height = height; var left = (document.body.clientWidth - width) / 2; var top = (document.body.clientHeight - height) / 2; this.object.setSize(this.object.xWin.offsetWidth, this.object.xWin.offsetHeight); this.object.moveTo(left, top); var w = document.body.clientWidth; var h = document.body.clientHeight + this.height - 26; this.object.setRange(0, 0, w, h); }, // free free: function () { return true; } , //modified by songxb@2007-05-15 增加三个参数 sSrc:页面地址,sWidth:窗口宽度,sHeight:窗口高度 doQuery: function (oEdit, sType, sParameter,sSrc,sWidth,sHeight) { var sURL = QUERY_FILE_PATH; if (sType.substr(0,1) != "#") { var iType = eval("QUERY_BY_" + sType.toUpperCase()); this.object.setTitle("\u67e5\u8be2\u7a97\u53e3"); switch (iType) { case QUERY_BY_PERSON: this.object.setTitle("实有人口选择"); sURL += "yswh/ryswh/gaJcxxRkSyrkQuery.jsp"; break; case QUERY_BY_ADDRESS: this.object.setTitle("地址选择"); if(oEdit.limit){ sURL += "yswh/dyswh/gaJcxxDzDysQuery.jsp?limit="+oEdit.limit; }else{ sURL += "yswh/dyswh/gaJcxxDzDysQuery.jsp"; } break; case QUERY_BY_ORG: sURL += "yswh/zzyswh/OrgInfoQuery.jsp"; break; case QUERY_BY_UNIT: sURL += "cx/hxxcx/hxxcxCzrkHxx.jsp"; break; case QUERY_BY_STATION: sURL += "Query_Station.asp"; break; case QUERY_BY_PHOTO: this.object.setTitle("照片采集"); sURL += "PhotoCollection.htm"; break; case QUERY_BY_AJXX: sURL += "yswh/ajyswh/gaJcxxAjAjjbxxQuery.jsp"; break; case QUERY_BY_MJXX: sURL += "zsjs/mjgl/mjQuery.jsp"; break; // add by songxb@2007-05-15 case QUERY_BY_COMMON: sURL += sSrc; break; //add start case QUERY_BY_GAB: sURL += sSrc; break; case QUERY_BY_FZXX: sURL += sSrc; break; //add end //------------------- zl add case QUERY_BY_CUSTINFO: var qdID = document.getElementById('QD_ID').code?document.getElementById('QD_ID').code:document.getElementById('QD_ID').value; sURL += "crm/khgl/custQuery.jsp?qdID="+qdID; break; //--------------------add end //--------------------zl add 0908-------------------- case QUERY_BY_UNITINFO: var khValue=document.getElementById('KH_ID').code?document.getElementById('KH_ID').code:document.getElementById('KH_ID').value; sURL+="crm/unit/unitQuery.jsp?custid="+khValue; break; case QUERY_BY_MANAGER: sURL+="crm/sell/queryManager.jsp"; break; //---------------------------------------------- //---Zhy Add 081208 Start--- case QUERY_BY_STAFF: sURL += "toll/queryPerson.jsp"; break; //--- Zhy Add 081208 End --- } } else { sURL += sType.substr(1); } if(sURL.indexOf("?")>0){ sURL += "&rad=" + getRandom(); }else{ sURL += "?rad=" + getRandom(); } if (typeof(sParameter) != "undefined") { sURL += "&" + sParameter; } // modified by songxb@2007-05-15 // iType == QUERY_BY_PHOTO ? this.setClient(sURL, 300, 240) : this.setClient(sURL, 750, 320); var tWidth = 750; var tHeight = 320; if(iType == QUERY_BY_PHOTO){ tWidth = sWidth > 0?sWidth : 300; tHeight = sHeight > 0?sHeight : 240; }else if(iType == QUERY_BY_COMMON){ tWidth = sWidth > 0?sWidth : 750; tHeight = sHeight > 0?sHeight : 320; }else if(iType == QUERY_BY_ADDRESS){ tHeight = sHeight > 0?sHeight : 430; }else if(iType == QUERY_BY_STAFF) { tHeight = sHeight > 0?sHeight : 350; } this.setClient(sURL, tWidth, tHeight) this.object.show(); } } ///////////////////////////////////////////////////////////////////// // 代码隔离,以下的代码是重复copy过来的 // // ///////////////////////////////////////////////////////////////////// //----------------------------------------------- // 取随机数 // 是否属于重复代码:是 //----------------------------------------------- function getRandom () { if((navigator.appName == "Netscape") && ((navigator.appVersion.indexOf("2.0") >= 0) || (navigator.appVersion.indexOf("Win3") >= 0))) { now = new Date(); // pseudo random return (now.getTime() % 1000000) / 1000000; } else { return Math.random(); } } function doClose() { parent.g_xQuery.hidden(); } function doOK(){ var obj = parent.g_xQuery.edit; if(tabList2.getSelectedRow() ==null ){ alert('请选择一条记录'); return; } var selectRowXML = tabList2.getSelectedRow().rowxml; var selectRow = tabList2.getSelectedRow(); if(obj.rkname){ parent.document.all(obj.rkname).value=selectRow.XM; parent.document.all(obj.rkname).code=selectRow.XM; } if(obj.rksfzh){ parent.document.all(obj.rksfzh).value=selectRow.GMSFHM; parent.document.all(obj.rksfzh).code=selectRow.GMSFHM; } if(obj.rkbm){ parent.document.all(obj.rkbm).value=selectRow.RKBM; parent.document.all(obj.rkbm).code=selectRow.RKBM; } if(obj.addressField){ parent.document.all(obj.addressField).value=selectRow.QDZ; parent.document.all(obj.addressField).code=selectRow.DYSID; } if(obj.src=="address"){ parent.doOrgQueryQdzOver(selectRow); }else if(obj.src=="gab"){ parent.doSelectPersion(selectRowXML); }else if(obj.src=="fzxx"){ parent.doSelectFzxx(selectRowXML); }else{ parent.doQueryOver(selectRow); } doClose(); } function doSelectedOrg() { var obj = parent.g_xQuery.edit; var selectRowXML = tabList2.getSelectedRow().rowxml; var selectRow = tabList2.getSelectedRow(); if(obj.dwmc){ parent.document.all(obj.dwmc).value=selectRow.DWMC; parent.document.all(obj.dwmc).code=selectRow.DWMC; } if(obj.zzjgdm){ parent.document.all(obj.zzjgdm).value=selectRow.ZZJGDM; parent.document.all(obj.zzjgdm).code=selectRow.ZZJGDM; } if(obj.dwbm){ parent.document.all(obj.dwbm).value=selectRow.DWBM; parent.document.all(obj.dwbm).code=selectRow.DWBM; } parent.doOrgQueryOver(selectRow); doClose(); } function doQueryOrgByZzjgdm(obj) { var arr_Condition = []; var sLogic ="and"; var sFieldName ="ZZJGDM"; var sOperation ="="; var sValue =obj[0].value; var sType =""; var sFormat = ""; arr_Condition[0] =makeCondition( sLogic,sFieldName, sOperation, sValue, "",sType,sFormat); var xmlConditions= makeConditions(arr_Condition); sXML = makeQueryCondition("",xmlConditions); var sActionURL = g_sRootPath+"/yswh/GaJcxxZzDwjbxxAction.do?method=QueryList"; var xmlhttp2 = new ActiveXObject("Msxml2.XMLHTTP"); xmlhttp2.Open("POST",sActionURL,false); xmlhttp2.Send(sXML); var res = xmlhttp2.responseText; xmlhttp2 = null; doProcessQueryOrgResult(res,obj); } function doProcessQueryOrgResult(resultXml,obj) { var xmlDom = createDOMDocument(); xmlDom.loadXML(resultXml); var list = xmlDom.selectNodes("//RESPONSE/RESULT/ROW"); if (list.length==0) { doOrgQueryOver(); return; } var arr = new Object(); for(var j=0;j<list[0].childNodes.length;j++) { arr[list[0].childNodes[j].tagName] = list[0].childNodes[j].text; if(list[0].childNodes[j].getAttribute("sv")) { var sv = list[0].childNodes[j].tagName+"_SV"; arr[sv] = list[0].childNodes[j].getAttribute("sv"); } } arr.rowxml= list[0].xml; if(obj.dwmc){ document.all(obj.dwmc).value=arr.DWMC; document.all(obj.dwmc).code=arr.DWMC; } if(obj.zzjgdm){ document.all(obj.zzjgdm).value=arr.ZZJGDM; document.all(obj.zzjgdm).code=arr.ZZJGDM; } if(obj.dwbm){ document.all(obj.dwbm).value=arr.DWBM; document.all(obj.dwbm).code=arr.DWBM; } if(typeof(doOrgQueryOver) != "undefined") { doOrgQueryOver(arr); } } function doOrgQueryOver(queryResultArr) { } function doOrgQueryQdzOver(queryResultArr) { } //回调函数 function doQueryOver(queryResultArr){ } function doQueryPerson(queryConditionObj,obj) { var arr_Condition = []; for (var i =0;i<queryConditionObj.length;i++){ var sLogic = queryConditionObj[i].logic; var sFieldName = queryConditionObj[i].fieldname; var sOperation = queryConditionObj[i].operation; var sValue = queryConditionObj[i].value; var sType = queryConditionObj[i].type; var sFormat = queryConditionObj[i].format; sOperation = sOperation.replace(/</,"&lt;"); sOperation = sOperation.replace(/>/,"&gt;"); if(sType==null){ sType =""; } if(sFormat==null){ sFormat =""; } arr_Condition[i] =makeCondition( sLogic,sFieldName, sOperation, sValue, "",sType,sFormat); } var xmlConditions= makeConditions(arr_Condition); sXML = makeQueryCondition("",xmlConditions); var sActionURL = g_sRootPath+"/yswh/GaJcxxRkSyrkAction.do?method=QueryList"; var xmlhttp2 = new ActiveXObject("Msxml2.XMLHTTP"); xmlhttp2.Open("POST",sActionURL,false); xmlhttp2.Send(sXML); var res = xmlhttp2.responseText; xmlhttp2 = null; doProcessQueryPersonResult(res,obj); } var mutirowxml = ""; function doProcessQueryPersonResult(resultXml,obj) { var xmlDom = createDOMDocument(); xmlDom.loadXML(resultXml); var list = xmlDom.selectNodes("//RESPONSE/RESULT/ROW"); var arr = []; for(var i=0;i<list.length;i++) { arr[i] = new Object(); for(var j=0;j<list[i].childNodes.length;j++) { arr[i][list[i].childNodes[j].tagName] = list[i].childNodes[j].text; if(list[i].childNodes[j].getAttribute("sv")) { var sv = list[i].childNodes[j].tagName+"_SV"; arr[i][sv] = list[i].childNodes[j].getAttribute("sv"); } } arr[i].rowxml= list[i].xml; } if(arr.length == 1) { if(obj.rkname){ document.all(obj.rkname).value=arr[0].XM; document.all(obj.rkname).code=arr[0].XM; } if(obj.rksfzh){ document.all(obj.rksfzh).value=arr[0].GMSFHM; document.all(obj.rksfzh).code=arr[0].GMSFHM; } if(obj.rkbm){ document.all(obj.rkbm).value=arr[0].RKBM; document.all(obj.rkbm).code=arr[0].RKBM; } }else if(arr.length>1){ mutirowxml =resultXml; var muti = document.createElement("input"); muti.kind="query"; muti.src="common"; muti.url="yswh/ryswh/gaJcxxRkSyrkResults.jsp"; muti.sWidth="750"; muti.sHeight="320"; if(obj.rkname){ muti.rkname = obj.rkname; } if(obj.rkbm){ muti.rkbm = obj.rkbm; } if(obj.rksfzh){ muti.rksfzh = obj.rksfzh; } if(obj.fieldname){ muti.fieldname = obj.fieldname; } g_xQuery.show(muti); return; } if(arr.length!=0) if(typeof(doQueryOver) != "undefined") { doQueryOver(arr[0]); } } //-----------------------------------zl add 080716------------------------------ function doSelectedCust() { if (tabList2.getSelectedRowIndex()==-1) { alert("请选择一条记录"); return; } var obj = parent.g_xQuery.edit; var selectRowXML = tabList2.getSelectedRow().rowxml; var selectRow = tabList2.getSelectedRow(); if(obj.parent){ parent.document.all(obj.parent).value=selectRow.KH_NAME; parent.document.all(obj.parent).code=selectRow.KH_ID; } parent.doOrgQueryOver(selectRow); doClose(); } //-----------------------------------zl add end--------------------------------- //----------------------------zl add 080908------------------------------------ function doSelectedUnit() { if (tabList1.getSelectedRowIndex()==-1) { alert("请选择一条记录"); return; } var obj = parent.g_xQuery.edit; var selectRowXML = tabList1.getSelectedRow().rowxml; var selectRow = tabList1.getSelectedRow(); if(obj.parent){ parent.document.all(obj.parent).value=selectRow.YH_NAME; parent.document.all(obj.parent).code=selectRow.YH_ID; } parent.doOrgQueryOver(selectRow); doClose(); } function doSelectedManager() { if (tabList3.getSelectedRowIndex()==-1) { alert("请选择一条记录"); return; } var obj = parent.g_xQuery.edit; var selectRowXML = tabList3.getSelectedRow().rowxml; var selectRow = tabList3.getSelectedRow(); if(obj.parent){ parent.document.all(obj.parent).value=selectRow.XM; parent.document.all(obj.parent).code=selectRow.KHJLBH; } parent.doOrgQueryOver(selectRow); doClose(); } //---------------------------add end--------------------------------------- //---Zhy Add 081208 Start--- function doSelectedPerson() { if (tabList0.getSelectedRowIndex() != -1) { var obj = parent.g_xQuery.edit; var selectRowXML = tabList0.getSelectedRow().rowxml; var selectRow = tabList0.getSelectedRow(); if (obj.parent) { parent.document.all(obj.parent).value=selectRow.ZHZWM parent.document.all(obj.parent).code=selectRow.USERNAME; } parent.doOrgQueryOver(selectRow); doClose(); } else { alert('您还没有选择人员，请先选择！'); } } //--- Zhy Add 081208 End --- 